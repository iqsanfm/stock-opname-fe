<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Opname Barang - Daily & Monthly</title>
    <link rel="icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authModal" class="auth-container" style="display: block;">
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
            <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
        </div>
        <div class="auth-content">
            <div id="loginForm">
                <h2>Login</h2>
                <form id="loginFormElement">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-success">Login</button>
                </form>
                <div class="demo-accounts-info">
                    <div class="demo-header">
                        <span class="demo-icon">üîë</span>
                        <h4>Akun Demo</h4>
                    </div>
                    <div class="demo-account">
                        <div class="demo-role admin">üëë ADMIN</div>
                        <div class="demo-credentials">
                            <span class="demo-email">admin@inventory.com</span>
                            <span class="demo-password">password123</span>
                        </div>
                    </div>
                    <div class="demo-account">
                        <div class="demo-role user">üë§ USER</div>
                        <div class="demo-credentials">
                            <span class="demo-email">user1@inventory.com</span>
                            <span class="demo-password">password123</span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="registerForm" style="display: none;">
                <h2>Register</h2>
                <form id="registerFormElement">
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="registerRole">Role</label>
                        <select id="registerRole">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">Register</button>
                </form>
            </div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="user-info" id="userInfo"></div>
        <div class="header">
            <h1>Stock Opname System</h1>
            <p>Sistem Manajemen Inventory dengan Transaksi Harian & Akumulasi Bulanan</p>
        </div>

        <div class="main-content">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('daily')">Transaksi Harian</button>
                <button class="tab-button" onclick="switchTab('monthly')">Laporan Bulanan</button>
                <button class="tab-button" onclick="switchTab('opname')">Stock Opname</button>
            </div>

            <!-- Daily Transactions Tab -->
            <div id="dailyTab" class="tab-content active">
                <!-- Daily Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="dailyTransactions">0</div>
                        <div class="stat-label">Transaksi Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dailyIn">0</div>
                        <div class="stat-label">Total Barang Masuk</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dailyOut">0</div>
                        <div class="stat-label">Total Barang Keluar</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dailyValue">Rp 0</div>
                        <div class="stat-label">Nilai Transaksi</div>
                    </div>
                </div>

                <!-- Daily Transaction Form -->
                <div class="form-section">
                    <h2>Input Transaksi Harian</h2>
                    <form id="dailyTransactionForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="tanggal">Tanggal Transaksi</label>
                                <input type="date" id="tanggal" name="tanggal" required>
                            </div>
                            <div class="form-group">
                                <label for="sku_daily">SKU</label>
                                <input type="text" id="sku_daily" name="sku" required placeholder="Contoh: LP001, KA001, MK001" list="skuList" onchange="autoFillFromSKU()" oninput="delayedAutoFill()">
                                <datalist id="skuList"></datalist>
                            </div>
                            <div class="form-group">
                                <label for="sparepart_daily">Nama Barang</label>
                                <input type="text" id="sparepart_daily" name="sparepart" required list="sparepartsList" placeholder="Contoh: Laptop, Kertas A4, Meja Kantor, dll">
                                <datalist id="sparepartsList"></datalist>
                            </div>
                            <div class="form-group">
                                <label for="jenis_daily">Jenis/Kategori</label>
                                <input type="text" id="jenis_daily" name="jenis" required placeholder="Contoh: Elektronik, Makanan, Alat Tulis, dll">
                            </div>
                            <div class="form-group">
                                <label for="merk_daily">Merk</label>
                                <input type="text" id="merk_daily" name="merk" required placeholder="Contoh: HP, Canon, IKEA, dll">
                            </div>
                            <div class="form-group">
                                <label for="tipe_transaksi">Tipe Transaksi</label>
                                <select id="tipe_transaksi" name="tipe_transaksi" required onchange="toggleTransactionFields()">
                                    <option value="">Pilih Tipe</option>
                                    <option value="masuk">Barang Masuk</option>
                                    <option value="keluar">Barang Keluar</option>
                                    <option value="stock_awal">Stock Awal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="jumlah">Jumlah</label>
                                <input type="number" id="jumlah" name="jumlah" min="0" required>
                            </div>
                            <div class="form-group" id="hargaGroup">
                                <label for="harga">Harga per Unit</label>
                                <input type="number" id="harga" name="harga" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="keterangan">Keterangan</label>
                                <input type="text" id="keterangan" name="keterangan" placeholder="Opsional">
                            </div>
                        </div>
                        <div class="actions">
                            <button type="submit" class="btn btn-success">Simpan Transaksi</button>
                            <button type="button" class="btn" onclick="clearDailyForm()">Reset Form</button>
                        </div>
                    </form>
                </div>

                <!-- Daily Transactions Table -->
                <div class="form-section">
                    <h2>Transaksi Harian</h2>
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="filterDate">Filter Tanggal</label>
                            <input type="date" id="filterDate" onchange="filterDailyTransactions()">
                        </div>
                        <div class="form-group">
                            <label for="filterSparepart">Filter Nama Barang</label>
                            <input type="text" id="filterSparepart" placeholder="Cari nama barang..." onkeyup="filterDailyTransactions()">
                        </div>
                        <div class="form-group">
                            <label for="filterType">Filter Tipe</label>
                            <select id="filterType" onchange="filterDailyTransactions()">
                                <option value="">Semua Tipe</option>
                                <option value="stock_awal">Stock Awal</option>
                                <option value="masuk">Barang Masuk</option>
                                <option value="keluar">Barang Keluar</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button class="btn" onclick="exportDailyTransactions()">Export Transaksi</button>
                        <button class="btn btn-warning" onclick="generateMonthlyReport()">Generate Laporan Bulanan</button>
                        <button class="btn btn-success" onclick="exportAllData()">Backup Data</button>
                        <button class="btn" onclick="importData()">Import Data</button>
                        <button class="btn btn-primary" onclick="importCSV()">Import CSV</button>
                        <button class="btn btn-warning" onclick="checkDataIntegrity()">Cek Konsistensi Data</button>
                        <button class="btn btn-danger" onclick="deleteAllData()">üóëÔ∏è Hapus Semua Data</button>
                        <input type="file" id="importFile" accept=".json" style="display: none" onchange="handleImportFile(event)">
                        <input type="file" id="importCSVFile" accept=".csv" style="display: none" onchange="handleImportCSVFile(event)">
                    </div>

                    <div class="table-container">
                        <table id="dailyTransactionsTable">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>SKU</th>
                                    <th>Nama Barang</th>
                                    <th>Jenis</th>
                                    <th>Merk</th>
                                    <th>Tipe</th>
                                    <th>Jumlah</th>
                                    <th>Harga</th>
                                    <th>Total</th>
                                    <th>Keterangan</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dailyTransactionsBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Monthly Report Tab -->
            <div id="monthlyTab" class="tab-content">
                <!-- Monthly Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="monthlyItems">0</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monthlyValue">Rp 0</div>
                        <div class="stat-label">Total Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monthlyIn">0</div>
                        <div class="stat-label">Total Masuk Bulan Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monthlyOut">0</div>
                        <div class="stat-label">Total Keluar Bulan Ini</div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Laporan Bulanan</h2>
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="reportMonth">Pilih Bulan : Di Menu Bulan</label>
                            <input type="month" id="reportMonth" onchange="displayMonthlyReport()">
                        </div>
                        <div class="form-group">
                            <label for="filterMonthlySparepart">Filter Nama Barang</label>
                            <input type="text" id="filterMonthlySparepart" placeholder="Cari nama barang..." onkeyup="displayMonthlyReport()">
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn" onclick="exportMonthlyReport()">Export Laporan Bulanan</button>
                        <button class="btn btn-warning" onclick="copyToOpname()">Copy ke Stock Opname</button>
                    </div>

                    <div class="table-container">
                        <table id="monthlyReportTable">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>Nama Barang</th>
                                    <th>Jenis</th>
                                    <th>Merk</th>
                                    <th>Stock Awal</th>
                                    <th>Harga Awal</th>
                                    <th>Barang Masuk</th>
                                    <th>Barang Keluar</th>
                                    <th>Stock Akhir</th>
                                    <th>Harga Rata - Rata</th>
                                    <th>Total Value</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyReportBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stock Opname Tab -->
            <div id="opnameTab" class="tab-content">
                <!-- Opname Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="opnameItems">0</div>
                        <div class="stat-label">Items di Opname</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="opnameValue">Rp 0</div>
                        <div class="stat-label">Total Value Opname</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="selisihPositif">0</div>
                        <div class="stat-label">Selisih Lebih</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="selisihNegatif">0</div>
                        <div class="stat-label">Selisih Kurang</div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Stock Opname</h2>
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="opnameMonth">Bulan Opname</label>
                            <input type="month" id="opnameMonth" onchange="displayOpnameData()">
                        </div>
                        <div class="form-group">
                            <label for="filterOpnameSparepart">Filter Nama Barang</label>
                            <input type="text" id="filterOpnameSparepart" placeholder="Cari nama barang..." onkeyup="displayOpnameData()">
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn" onclick="exportOpnameReport()">Export Stock Opname</button>
                        <button class="btn btn-success" onclick="saveOpnameResults()">Simpan Hasil Opname</button>
                    </div>

                    <div class="table-container">
                        <table id="opnameTable">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>Nama Barang</th>
                                    <th>Jenis</th>
                                    <th>Merk</th>
                                    <th>Stock Sistem</th>
                                    <th>Stock Fisik (Input)</th>
                                    <th>Selisih</th>
                                    <th>Harga</th>
                                    <th>Value Sistem</th>
                                    <th>Value Fisik</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>
                            <tbody id="opnameBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration - Point to separate backend
        const API_BASE_URL = 'https://backend-vercel-nu-sable.vercel.app';
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        
        // Data storage (will be replaced with API calls)
        let dailyTransactions = [];
        let monthlyReports = [];
        let opnameData = [];

        // Initialize demo users (for local fallback only)
        function initializeDemoUsers() {
            const existingUsers = localStorage.getItem('registeredUsers');
            if (!existingUsers) {
                const demoUsers = [
                    {
                        username: 'admin',
                        email: 'admin@inventory.com',
                        password: 'password123',
                        role: 'admin'
                    },
                    {
                        username: 'user1',
                        email: 'user1@inventory.com', 
                        password: 'password123',
                        role: 'user'
                    }
                ];
                localStorage.setItem('registeredUsers', JSON.stringify(demoUsers));
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeDemoUsers();
            checkAuthStatus();
            
            // Set today's date as default
            if (document.getElementById('tanggal')) {
                document.getElementById('tanggal').valueAsDate = new Date();
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
                document.getElementById('opnameMonth').value = new Date().toISOString().slice(0, 7);
                
                loadDailyTransactions();
                updateDailyStatistics();
                displayDailyTransactions();
                displayMonthlyReport();
                displayOpnameData();
                updateSparepartsList();
                updateUIBasedOnRole();
            }
        });
        
        // Update UI based on user role
        function updateUIBasedOnRole() {
            if (!currentUser) return;
            
            // Hide sensitive buttons for regular users
            if (currentUser.role === 'user') {
                const sensitiveButtons = [
                    'button[onclick="importData()"]',
                    'button[onclick="importCSV()"]',
                    'button[onclick="deleteAllData()"]'
                ];
                
                sensitiveButtons.forEach(selector => {
                    const button = document.querySelector(selector);
                    if (button) {
                        button.style.display = 'none';
                    }
                });
            }
        }

        // Authentication functions
        function checkAuthStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                hideAuthModal();
                setTimeout(() => {
                    updateUserInfo();
                    updateUIBasedOnRole();
                }, 100);
                loadDailyTransactions();
            } else {
                showAuthModal();
            }
        }

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'login') {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
            } else {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
            }
        }

        // API helper function
        async function apiCall(endpoint, method = 'GET', data = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            const config = {
                method,
                headers
            };
            
            if (data && (method === 'POST' || method === 'PUT')) {
                config.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'API Error');
                }
                
                return result;
            } catch (error) {
                console.error('API Call Error:', error);
                throw error;
            }
        }

        // Login form handler
        document.getElementById('loginFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                // Try backend authentication first
                const loginData = { email, password };
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                const result = await response.json();
                
                if (result.success && result.token) {
                    // Backend authentication successful
                    authToken = result.token;
                    currentUser = {
                        id: result.user.id,
                        username: result.user.username,
                        email: result.user.email,
                        role: result.user.role
                    };
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    hideAuthModal();
                    setTimeout(() => {
                        updateUserInfo();
                        updateUIBasedOnRole();
                        updateSparepartsList(); // Update SKU suggestions from API
                    }, 100);
                    loadDailyTransactions();
                    showAlert('Login berhasil! (Backend API)', 'success');
                } else {
                    throw new Error(result.message || 'Login gagal');
                }
            } catch (error) {
                console.log('Backend login failed, trying local auth:', error.message);
                
                // Fallback to local authentication
                const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
                const user = users.find(u => u.email === email && u.password === password);
                
                if (user) {
                    currentUser = {
                        username: user.username,
                        email: user.email,
                        role: user.role
                    };
                    
                    authToken = null; // No token for local auth
                    localStorage.removeItem('authToken');
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    hideAuthModal();
                    setTimeout(() => {
                        updateUserInfo();
                        updateUIBasedOnRole();
                        updateSparepartsList(); // Update with local data
                    }, 100);
                    loadDailyTransactions();
                    showAlert('Login berhasil! (Mode Offline)', 'success');
                } else {
                    showAlert('Email atau password salah!', 'error');
                }
            }
        });

        // Register form handler
        document.getElementById('registerFormElement').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('registerRole').value;
            
            // Get existing users
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            
            // Check if email already exists
            if (users.find(u => u.email === email)) {
                showAlert('Email sudah terdaftar!', 'error');
                return;
            }
            
            // Add new user
            const newUser = { username, email, password, role };
            users.push(newUser);
            localStorage.setItem('registeredUsers', JSON.stringify(users));
            
            currentUser = {
                username: newUser.username,
                email: newUser.email,
                role: newUser.role
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            hideAuthModal();
            setTimeout(() => {
                updateUserInfo();
                updateUIBasedOnRole();
            }, 100);
            loadDailyTransactions();
            showAlert('Registrasi berhasil!', 'success');
        });

        // Role-based access control
        function hasPermission(action) {
            if (!currentUser) return false;
            
            // Admin has access to all actions
            if (currentUser.role === 'admin') {
                return true;
            }
            
            // User permissions - can't edit/delete sensitive data
            if (currentUser.role === 'user') {
                const restrictedActions = ['delete', 'deleteAllData', 'importData', 'importCSV'];
                return !restrictedActions.includes(action);
            }
            
            return false;
        }

        function updateUserInfo() {
            if (currentUser) {
                const roleColor = currentUser.role === 'admin' ? '#e74c3c' : '#3498db';
                document.getElementById('userInfo').innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: flex-start;">
                        <strong style="font-size: 1rem;">${currentUser.username}</strong>
                        <span style="color: ${roleColor}; font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">
                            ${currentUser.role === 'admin' ? 'üëë ADMIN' : 'üë§ USER'}
                        </span>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        üö™ Logout
                    </button>
                `;
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            dailyTransactions = [];
            monthlyReports = [];
            opnameData = [];
            showAuthModal();
            showAlert('Logout berhasil!', 'success');
        }

        // Enhanced localStorage functions for persistent data
        function saveAllData() {
            try {
                localStorage.setItem('dailyTransactions', JSON.stringify(dailyTransactions));
                localStorage.setItem('monthlyReports', JSON.stringify(monthlyReports));
                localStorage.setItem('opnameData', JSON.stringify(opnameData));
                
                // Also save to backup
                const backupData = {
                    dailyTransactions,
                    monthlyReports,
                    opnameData,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('stockOpnameBackup', JSON.stringify(backupData));
                console.log('Data saved successfully');
            } catch (error) {
                console.error('Error saving data:', error);
                showAlert('Error menyimpan data: ' + error.message, 'error');
            }
        }

        function loadAllData() {
            try {
                // Load main data
                dailyTransactions = JSON.parse(localStorage.getItem('dailyTransactions')) || [];
                monthlyReports = JSON.parse(localStorage.getItem('monthlyReports')) || [];
                opnameData = JSON.parse(localStorage.getItem('opnameData')) || [];
                
                // Check backup if main data is empty
                if (dailyTransactions.length === 0 && monthlyReports.length === 0) {
                    const backup = JSON.parse(localStorage.getItem('stockOpnameBackup'));
                    if (backup) {
                        dailyTransactions = backup.dailyTransactions || [];
                        monthlyReports = backup.monthlyReports || [];
                        opnameData = backup.opnameData || [];
                        console.log('Data loaded from backup:', backup.savedAt);
                    }
                }
                
                console.log('Data loaded - Transactions:', dailyTransactions.length, 'Reports:', monthlyReports.length);
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error memuat data: ' + error.message, 'error');
            }
        }

        async function loadDailyTransactions() {
            loadAllData();
        }

        // Utility functions
        function formatNumber(num) {
            return Math.round(num).toLocaleString('id-ID');
        }

        function formatCurrency(num) {
            return 'Rp ' + formatNumber(num);
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Tab switching
        function switchTab(tab) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // Update data when switching tabs
            if (tab === 'daily') {
                updateDailyStatistics();
                displayDailyTransactions();
            } else if (tab === 'monthly') {
                displayMonthlyReport();
            } else if (tab === 'opname') {
                displayOpnameData();
            }
        }

        // Validation functions
        function validateTransaction(data) {
            const errors = [];
            const warnings = [];

            // Basic validation
            if (!data.sku || data.sku.trim().length < 2) {
                errors.push('SKU harus minimal 2 karakter');
            }

            if (!data.sparepart || data.sparepart.trim().length < 2) {
                errors.push('Nama barang harus minimal 2 karakter');
            }

            if (!data.jenis) {
                errors.push('Jenis barang harus diisi');
            }

            if (!data.merk || data.merk.trim().length < 1) {
                errors.push('Merk harus diisi');
            }

            if (!data.tipe_transaksi) {
                errors.push('Tipe transaksi harus dipilih');
            }

            if (!data.jumlah || data.jumlah <= 0) {
                errors.push('Jumlah harus lebih dari 0');
            }

            if (data.tipe_transaksi !== 'keluar' && (!data.harga || data.harga <= 0)) {
                errors.push('Harga harus lebih dari 0 untuk transaksi masuk/stock awal');
            }

            // Check for duplicate SKU only for different items (different sparepart/jenis/merk)
            const existingSKU = dailyTransactions.find(t => 
                t.sku && t.sku.toUpperCase() === data.sku.toUpperCase() &&
                (t.sparepart.toLowerCase().trim() !== data.sparepart.toLowerCase().trim() ||
                 t.jenis !== data.jenis ||
                 t.merk.toLowerCase().trim() !== data.merk.toLowerCase().trim())
            );

            if (existingSKU) {
                errors.push(`SKU '${data.sku}' sudah digunakan untuk item berbeda: ${existingSKU.sparepart} (${existingSKU.jenis} - ${existingSKU.merk})`);
            }

            // Check for duplicates on same date
            const sameDate = dailyTransactions.filter(t => t.tanggal === data.tanggal);
            const duplicate = sameDate.find(t => 
                t.sparepart.toLowerCase().trim() === data.sparepart.toLowerCase().trim() &&
                t.jenis === data.jenis &&
                t.merk.toLowerCase().trim() === data.merk.toLowerCase().trim() &&
                t.tipe_transaksi === data.tipe_transaksi
            );

            if (duplicate) {
                warnings.push(`Item yang sama sudah ada di tanggal ${data.tanggal}. Yakin ingin menambah lagi?`);
            }

            // Check for multiple stock_awal entries
            if (data.tipe_transaksi === 'stock_awal') {
                const existingStockAwal = dailyTransactions.find(t => 
                    t.sparepart.toLowerCase().trim() === data.sparepart.toLowerCase().trim() &&
                    t.jenis === data.jenis &&
                    t.merk.toLowerCase().trim() === data.merk.toLowerCase().trim() &&
                    t.tipe_transaksi === 'stock_awal'
                );

                if (existingStockAwal) {
                    warnings.push(`Stock awal untuk item ini sudah ada. Sebaiknya edit yang lama atau gunakan 'Barang Masuk'.`);
                }
            }

            // Price consistency check
            const similarItems = dailyTransactions.filter(t => 
                t.sparepart.toLowerCase().trim() === data.sparepart.toLowerCase().trim() &&
                t.jenis === data.jenis &&
                t.merk.toLowerCase().trim() === data.merk.toLowerCase().trim() &&
                t.harga > 0
            );

            if (similarItems.length > 0) {
                const avgPrice = similarItems.reduce((sum, t) => sum + t.harga, 0) / similarItems.length;
                const priceDifference = Math.abs(data.harga - avgPrice) / avgPrice;

                if (priceDifference > 0.2) { // More than 20% difference
                    warnings.push(`Harga berbeda signifikan dari rata-rata sebelumnya (Rp ${Math.round(avgPrice).toLocaleString('id-ID')}). Pastikan harga benar.`);
                }
            }

            // Check stock quantity logic
            if (data.tipe_transaksi === 'keluar') {
                const itemKey = `${data.sparepart.toLowerCase().trim()}_${data.jenis}_${data.merk.toLowerCase().trim()}`;
                
                // Calculate current stock
                const stockTransactions = dailyTransactions.filter(t => 
                    `${t.sparepart.toLowerCase().trim()}_${t.jenis}_${t.merk.toLowerCase().trim()}` === itemKey
                );

                const currentStock = stockTransactions.reduce((stock, t) => {
                    if (t.tipe_transaksi === 'stock_awal' || t.tipe_transaksi === 'masuk') {
                        return stock + t.jumlah;
                    } else if (t.tipe_transaksi === 'keluar') {
                        return stock - t.jumlah;
                    }
                    return stock;
                }, 0);

                if (data.jumlah > currentStock) {
                    warnings.push(`Stock tidak cukup! Stock saat ini: ${currentStock}, diminta: ${data.jumlah}`);
                }
            }

            return { errors, warnings };
        }

        // Daily transaction form submission
        document.getElementById('dailyTransactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                id: Date.now(), // Unique ID for editing
                tanggal: formData.get('tanggal'),
                sku: formData.get('sku').trim().toUpperCase(), // Normalize SKU to uppercase
                sparepart: formData.get('sparepart').trim(),
                jenis: formData.get('jenis'),
                merk: formData.get('merk').trim(),
                tipe_transaksi: formData.get('tipe_transaksi'),
                jumlah: parseInt(formData.get('jumlah')) || 0,
                harga: parseFloat(formData.get('harga')) || 0,
                keterangan: formData.get('keterangan') || '',
                total: (parseInt(formData.get('jumlah')) || 0) * (parseFloat(formData.get('harga')) || 0)
            };
            
            // Validate transaction
            const validation = validateTransaction(data);
            
            // Show errors if any
            if (validation.errors.length > 0) {
                showAlert('Error: ' + validation.errors.join(', '), 'error');
                return;
            }
            
            // Show warnings and ask for confirmation
            if (validation.warnings.length > 0) {
                const warningMessage = 'Peringatan:\n\n' + validation.warnings.join('\n\n') + '\n\nLanjutkan?';
                if (!confirm(warningMessage)) {
                    return;
                }
            }
            
            dailyTransactions.push(data);
            saveAllData(); // Auto-save dengan backup
            
            updateDailyStatistics();
            displayDailyTransactions();
            updateSparepartsList();
            clearDailyForm();
            
            showAlert('Transaksi berhasil disimpan!', 'success');
        });

        function toggleTransactionFields() {
            const tipeTransaksi = document.getElementById('tipe_transaksi').value;
            const hargaGroup = document.getElementById('hargaGroup');
            const hargaInput = document.getElementById('harga');
            
            if (tipeTransaksi === 'keluar') {
                hargaGroup.style.display = 'none';
                hargaInput.required = false;
                hargaInput.value = 0;
            } else {
                hargaGroup.style.display = 'block';
                hargaInput.required = true;
            }
        }


        function updateDailyStatistics() {
            const today = new Date().toISOString().split('T')[0];
            
            // Today's transactions for "Transaksi Hari Ini"
            const todayTransactions = dailyTransactions.filter(t => t.tanggal === today);
            const todayCount = todayTransactions.length;
            
            // All transactions for totals
            const allTransactions = dailyTransactions;
            const totalIn = allTransactions.filter(t => t.tipe_transaksi === 'masuk' || t.tipe_transaksi === 'stock_awal')
                            .reduce((sum, t) => sum + t.jumlah, 0);
            const totalOut = allTransactions.filter(t => t.tipe_transaksi === 'keluar')
                           .reduce((sum, t) => sum + t.jumlah, 0);
            const totalValue = allTransactions.reduce((sum, t) => sum + t.total, 0);
            
            // Update display
            document.getElementById('dailyTransactions').textContent = todayCount;
            document.getElementById('dailyIn').textContent = totalIn;
            document.getElementById('dailyOut').textContent = totalOut;
            document.getElementById('dailyValue').textContent = formatCurrency(totalValue);
        }

        function displayDailyTransactions() {
            const tbody = document.getElementById('dailyTransactionsBody');
            tbody.innerHTML = '';
            
            let filteredTransactions = [...dailyTransactions].reverse(); // Show newest first
            
            // Apply filters
            const dateFilter = document.getElementById('filterDate')?.value;
            const sparepartFilter = document.getElementById('filterSparepart')?.value.toLowerCase();
            const typeFilter = document.getElementById('filterType')?.value;
            
            if (dateFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.tanggal === dateFilter);
            }
            if (sparepartFilter) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.sparepart.toLowerCase().includes(sparepartFilter));
            }
            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.tipe_transaksi === typeFilter);
            }
            
            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.tanggal}</td>
                    <td>${transaction.sku || '-'}</td>
                    <td>${transaction.sparepart}</td>
                    <td>${transaction.jenis}</td>
                    <td>${transaction.merk}</td>
                    <td><span class="badge ${transaction.tipe_transaksi}">${transaction.tipe_transaksi.replace('_', ' ').toUpperCase()}</span></td>
                    <td>${transaction.jumlah}</td>
                    <td>${formatCurrency(transaction.harga)}</td>
                    <td>${formatCurrency(transaction.total)}</td>
                    <td>${transaction.keterangan || '-'}</td>
                    <td class="text-center">
                        ${hasPermission('delete') ? `<button class="btn btn-danger btn-small" onclick="deleteTransaction(${transaction.id})">Hapus</button>` : '<span class="text-muted">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterDailyTransactions() {
            displayDailyTransactions();
        }

        function deleteTransaction(id) {
            if (!hasPermission('delete')) {
                showAlert('Anda tidak memiliki izin untuk menghapus data!', 'error');
                return;
            }
            
            if (confirm('Yakin ingin menghapus transaksi ini?')) {
                dailyTransactions = dailyTransactions.filter(t => t.id !== id);
                saveAllData(); // Auto-save dengan backup
                displayDailyTransactions();
                updateDailyStatistics();
                showAlert('Transaksi berhasil dihapus!', 'success');
            }
        }

        function updateSparepartsList() {
            // Update spareparts datalist (local data)
            const sparepartsDatalist = document.getElementById('sparepartsList');
            const spareparts = [...new Set(dailyTransactions.map(t => t.sparepart))];
            
            sparepartsDatalist.innerHTML = '';
            spareparts.forEach(sparepart => {
                const option = document.createElement('option');
                option.value = sparepart;
                sparepartsDatalist.appendChild(option);
            });

            // Update SKU datalist from API if authenticated
            updateSKUDatalistFromAPI();
        }

        async function updateSKUDatalistFromAPI() {
            const skuDatalist = document.getElementById('skuList');
            
            // If not authenticated, use local data
            if (!authToken || !currentUser) {
                updateSKUDatalistLocal();
                return;
            }

            try {
                const response = await apiCall('/items/suggestions');
                if (response.success && response.data) {
                    skuDatalist.innerHTML = '';
                    response.data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.sku;
                        option.setAttribute('data-sparepart', item.name);
                        option.setAttribute('data-jenis', item.category);
                        option.setAttribute('data-merk', item.brand);
                        option.textContent = item.label;
                        skuDatalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading SKU suggestions from API:', error);
                // Fallback to local data
                updateSKUDatalistLocal();
            }
        }

        function updateSKUDatalistLocal() {
            const skuDatalist = document.getElementById('skuList');
            const uniqueItems = {};
            
            // Create unique items map with latest transaction data for each SKU
            dailyTransactions.forEach(t => {
                if (t.sku) {
                    uniqueItems[t.sku] = {
                        sku: t.sku,
                        sparepart: t.sparepart,
                        jenis: t.jenis,
                        merk: t.merk,
                        harga: t.harga
                    };
                }
            });
            
            skuDatalist.innerHTML = '';
            Object.values(uniqueItems).forEach(item => {
                const option = document.createElement('option');
                option.value = item.sku;
                option.setAttribute('data-sparepart', item.sparepart);
                option.setAttribute('data-jenis', item.jenis);
                option.setAttribute('data-merk', item.merk);
                option.setAttribute('data-harga', item.harga);
                option.textContent = `${item.sku} - ${item.sparepart}`;
                skuDatalist.appendChild(option);
            });
        }

        let autoFillTimeout;
        let lastFilledSKU = ''; // Track last filled SKU to prevent duplicate alerts
        
        function delayedAutoFill() {
            clearTimeout(autoFillTimeout);
            autoFillTimeout = setTimeout(() => {
                autoFillFromSKU(false); // false = don't show alert for input events
            }, 800); // 800ms delay to avoid too frequent calls
        }

        async function autoFillFromSKU(showAlert = true) {
            const skuInput = document.getElementById('sku_daily');
            const selectedSKU = skuInput.value.trim().toUpperCase(); // Convert to uppercase for consistency
            
            if (!selectedSKU || selectedSKU.length < 2) return;
            
            // Prevent duplicate processing of the same SKU
            if (selectedSKU === lastFilledSKU) return;
            
            let itemFound = false;
            
            // Try to get item from API first if authenticated
            if (authToken && currentUser) {
                try {
                    const response = await apiCall(`/items/sku/${selectedSKU}`);
                    if (response.success && response.data) {
                        const item = response.data;
                        // Auto-fill the form fields
                        document.getElementById('sparepart_daily').value = item.name;
                        document.getElementById('jenis_daily').value = item.category;
                        document.getElementById('merk_daily').value = item.brand;
                        
                        // For masuk transactions, suggest the base price
                        const tipeTransaksi = document.getElementById('tipe_transaksi').value;
                        if (tipeTransaksi === 'masuk' && item.averagePrice > 0) {
                            document.getElementById('harga').value = item.averagePrice;
                        }
                        
                        // Update last filled SKU
                        lastFilledSKU = selectedSKU;
                        itemFound = true;
                        
                        // Show info about the selected item only if requested
                        if (showAlert) {
                            showAlert(`‚úÖ Item ditemukan dari API: ${item.name} (${item.category} - ${item.brand})`, 'success');
                        }
                    }
                } catch (error) {
                    console.log('Item not found in API, trying local data...');
                }
            }
            
            // If not found in API, try local data
            if (!itemFound) {
                const existingItem = dailyTransactions.find(t => t.sku && t.sku.toUpperCase() === selectedSKU);
                
                if (existingItem) {
                    // Auto-fill the form fields
                    document.getElementById('sparepart_daily').value = existingItem.sparepart;
                    document.getElementById('jenis_daily').value = existingItem.jenis;
                    document.getElementById('merk_daily').value = existingItem.merk;
                    
                    // For masuk transactions, suggest the last known price
                    const tipeTransaksi = document.getElementById('tipe_transaksi').value;
                    if (tipeTransaksi === 'masuk' && existingItem.harga > 0) {
                        document.getElementById('harga').value = existingItem.harga;
                    }
                    
                    // Update last filled SKU
                    lastFilledSKU = selectedSKU;
                    itemFound = true;
                    
                    // Show info about the selected item only if requested
                    if (showAlert) {
                        showAlert(`‚úÖ Item ditemukan: ${existingItem.sparepart} (${existingItem.jenis} - ${existingItem.merk})`, 'success');
                    }
                }
            }
            
            if (!itemFound) {
                // Clear last filled SKU if not found
                lastFilledSKU = '';
            }
        }

        // Clear lastFilledSKU when form is reset
        function clearDailyForm() {
            document.getElementById('dailyTransactionForm').reset();
            document.getElementById('tanggal').valueAsDate = new Date();
            lastFilledSKU = ''; // Reset tracking
            toggleTransactionFields();
        }

        function generateMonthlyReport() {
            const reportMonth = document.getElementById('reportMonth').value;
            if (!reportMonth) {
                showAlert('Pilih bulan untuk generate laporan!', 'error');
                return;
            }

            const monthlyData = calculateMonthlyData(reportMonth);
            
            // Store monthly report
            const existingReportIndex = monthlyReports.findIndex(r => r.month === reportMonth);
            if (existingReportIndex >= 0) {
                monthlyReports[existingReportIndex] = { month: reportMonth, data: monthlyData };
            } else {
                monthlyReports.push({ month: reportMonth, data: monthlyData });
            }
            
            saveAllData(); // Auto-save dengan backup  
            displayMonthlyReport();
            showAlert('Laporan bulanan berhasil di-generate!', 'success');
        }

        function calculateMonthlyData(month) {
            const monthTransactions = dailyTransactions.filter(t => t.tanggal.startsWith(month));
            const sparepartGroups = {};

            // Group by SKU (or fallback to sparepart+jenis+merk for old data)
            monthTransactions.forEach(transaction => {
                const key = transaction.sku || `${transaction.sparepart}_${transaction.jenis}_${transaction.merk}`;
                
                if (!sparepartGroups[key]) {
                    sparepartGroups[key] = {
                        sku: transaction.sku || '',
                        sparepart: transaction.sparepart,
                        jenis: transaction.jenis,
                        merk: transaction.merk,
                        stockAwal: 0,
                        masuk: 0,
                        keluar: 0,
                        totalValueAwal: 0,
                        totalValueMasuk: 0,
                        hargaAwal: 0,
                        transactions: []
                    };
                }

                sparepartGroups[key].transactions.push(transaction);

                if (transaction.tipe_transaksi === 'stock_awal') {
                    sparepartGroups[key].stockAwal += transaction.jumlah;
                    sparepartGroups[key].totalValueAwal += transaction.total;
                    sparepartGroups[key].hargaAwal = transaction.harga;
                } else if (transaction.tipe_transaksi === 'masuk') {
                    sparepartGroups[key].masuk += transaction.jumlah;
                    sparepartGroups[key].totalValueMasuk += transaction.total;
                } else if (transaction.tipe_transaksi === 'keluar') {
                    sparepartGroups[key].keluar += transaction.jumlah;
                }
            });

            // Calculate final data using Weighted Average
            return Object.values(sparepartGroups).map(group => {
                const stockAkhir = group.stockAwal + group.masuk - group.keluar;
                
                // Weighted Average Calculation
                const totalValueAvailable = group.totalValueAwal + group.totalValueMasuk;
                const totalStockAvailable = group.stockAwal + group.masuk;
                
                const hargaRataRataWeighted = totalStockAvailable > 0 ? totalValueAvailable / totalStockAvailable : 0;
                const totalValue = stockAkhir * hargaRataRataWeighted;

                return {
                    sku: group.sku,
                    sparepart: group.sparepart,
                    jenis: group.jenis,
                    merk: group.merk,
                    stockAwal: group.stockAwal,
                    hargaAwal: group.hargaAwal,
                    masuk: group.masuk,
                    keluar: group.keluar,
                    stockAkhir: stockAkhir,
                    hargaRataRataWeighted: hargaRataRataWeighted,
                    totalValue: totalValue
                };
            });
        }

        function displayMonthlyReport() {
            const reportMonth = document.getElementById('reportMonth').value;
            const tbody = document.getElementById('monthlyReportBody');
            tbody.innerHTML = '';

            if (!reportMonth) return;

            let monthlyData = [];
            const existingReport = monthlyReports.find(r => r.month === reportMonth);
            
            if (existingReport) {
                monthlyData = existingReport.data;
            } else {
                monthlyData = calculateMonthlyData(reportMonth);
            }

            // Apply filter
            const sparepartFilter = document.getElementById('filterMonthlySparepart')?.value.toLowerCase();
            if (sparepartFilter) {
                monthlyData = monthlyData.filter(item => 
                    item.sparepart.toLowerCase().includes(sparepartFilter));
            }

            // Update statistics
            updateMonthlyStatistics(monthlyData, reportMonth);

            monthlyData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.sku || '-'}</td>
                    <td>${item.sparepart}</td>
                    <td>${item.jenis}</td>
                    <td>${item.merk}</td>
                    <td>${item.stockAwal}</td>
                    <td>${formatCurrency(item.hargaAwal)}</td>
                    <td>${item.masuk}</td>
                    <td>${item.keluar}</td>
                    <td>${item.stockAkhir}</td>
                    <td>${formatCurrency(item.hargaRataRataWeighted)}</td>
                    <td>${formatCurrency(item.totalValue)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateMonthlyStatistics(monthlyData, month) {
            const totalItems = monthlyData.reduce((sum, item) => sum + item.stockAkhir, 0);
            const totalValue = monthlyData.reduce((sum, item) => sum + item.totalValue, 0);
            const totalIn = monthlyData.reduce((sum, item) => sum + item.masuk, 0);
            const totalOut = monthlyData.reduce((sum, item) => sum + item.keluar, 0);

            document.getElementById('monthlyItems').textContent = totalItems;
            document.getElementById('monthlyValue').textContent = formatCurrency(totalValue);
            document.getElementById('monthlyIn').textContent = totalIn;
            document.getElementById('monthlyOut').textContent = totalOut;
        }

        function copyToOpname() {
            const reportMonth = document.getElementById('reportMonth').value;
            if (!reportMonth) {
                showAlert('Pilih bulan untuk copy ke stock opname!', 'error');
                return;
            }

            const existingReport = monthlyReports.find(r => r.month === reportMonth);
            if (!existingReport) {
                showAlert('Generate laporan bulanan terlebih dahulu!', 'error');
                return;
            }

            // Copy to opname data
            const opnameMonth = reportMonth;
            const existingOpnameIndex = opnameData.findIndex(o => o.month === opnameMonth);
            
            const opnameItems = existingReport.data.map(item => ({
                sku: item.sku,
                sparepart: item.sparepart,
                jenis: item.jenis,
                merk: item.merk,
                stockSistem: item.stockAkhir,
                stockFisik: item.stockAkhir, // Default to system stock
                selisih: 0,
                harga: item.hargaRataRataWeighted,
                valueSistem: item.totalValue,
                valueFisik: item.totalValue,
                keterangan: ''
            }));

            if (existingOpnameIndex >= 0) {
                opnameData[existingOpnameIndex] = { month: opnameMonth, data: opnameItems };
            } else {
                opnameData.push({ month: opnameMonth, data: opnameItems });
            }

            saveAllData(); // Auto-save dengan backup
            document.getElementById('opnameMonth').value = opnameMonth;
            
            showAlert('Data berhasil dicopy ke stock opname!', 'success');
            switchTab('opname');
        }

        function displayOpnameData() {
            const opnameMonth = document.getElementById('opnameMonth').value;
            const tbody = document.getElementById('opnameBody');
            tbody.innerHTML = '';

            if (!opnameMonth) return;

            const existingOpname = opnameData.find(o => o.month === opnameMonth);
            if (!existingOpname) return;

            let data = existingOpname.data;

            // Apply filter
            const sparepartFilter = document.getElementById('filterOpnameSparepart')?.value.toLowerCase();
            if (sparepartFilter) {
                data = data.filter(item => 
                    item.sparepart.toLowerCase().includes(sparepartFilter));
            }

            updateOpnameStatistics(data);

            data.forEach((item, index) => {
                // Find actual index in the original data array
                const actualIndex = existingOpname.data.findIndex(origItem => 
                    (origItem.sku && item.sku && origItem.sku === item.sku) ||
                    (origItem.sparepart === item.sparepart && 
                     origItem.jenis === item.jenis && 
                     origItem.merk === item.merk)
                );
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.sku || '-'}</td>
                    <td>${item.sparepart}</td>
                    <td>${item.jenis}</td>
                    <td>${item.merk}</td>
                    <td>${item.stockSistem}</td>
                    <td><input type="number" value="${item.stockFisik}" min="0" onchange="updateStockFisik(${actualIndex}, this.value)" class="form-control"></td>
                    <td class="${item.selisih > 0 ? 'positive' : item.selisih < 0 ? 'negative' : ''}">${item.selisih}</td>
                    <td>${formatCurrency(item.harga)}</td>
                    <td>${formatCurrency(item.valueSistem)}</td>
                    <td>${formatCurrency(item.valueFisik)}</td>
                    <td><input type="text" value="${item.keterangan}" onchange="updateKeterangan(${actualIndex}, this.value)" class="form-control" placeholder="Keterangan..."></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStockFisik(index, value) {
            const opnameMonth = document.getElementById('opnameMonth').value;
            const existingOpname = opnameData.find(o => o.month === opnameMonth);
            
            if (existingOpname && index >= 0 && index < existingOpname.data.length && existingOpname.data[index]) {
                const stockFisik = parseInt(value) || 0;
                existingOpname.data[index].stockFisik = stockFisik;
                existingOpname.data[index].selisih = stockFisik - existingOpname.data[index].stockSistem;
                existingOpname.data[index].valueFisik = stockFisik * existingOpname.data[index].harga;
                
                saveAllData(); // Auto-save dengan backup
                displayOpnameData();
            }
        }

        function updateKeterangan(index, value) {
            const opnameMonth = document.getElementById('opnameMonth').value;
            const existingOpname = opnameData.find(o => o.month === opnameMonth);
            
            if (existingOpname && index >= 0 && index < existingOpname.data.length && existingOpname.data[index]) {
                existingOpname.data[index].keterangan = value;
                saveAllData(); // Auto-save dengan backup
            }
        }

        function updateOpnameStatistics(data) {
            const totalItems = data.length;
            const totalValue = data.reduce((sum, item) => sum + item.valueFisik, 0);
            const selisihPositif = data.filter(item => item.selisih > 0).reduce((sum, item) => sum + item.selisih, 0);
            const selisihNegatif = Math.abs(data.filter(item => item.selisih < 0).reduce((sum, item) => sum + item.selisih, 0));

            document.getElementById('opnameItems').textContent = totalItems;
            document.getElementById('opnameValue').textContent = formatCurrency(totalValue);
            document.getElementById('selisihPositif').textContent = selisihPositif;
            document.getElementById('selisihNegatif').textContent = selisihNegatif;
        }

        function saveOpnameResults() {
            const opnameMonth = document.getElementById('opnameMonth').value;
            if (!opnameMonth) {
                showAlert('Pilih bulan opname!', 'error');
                return;
            }

            const existingOpname = opnameData.find(o => o.month === opnameMonth);
            if (!existingOpname) {
                showAlert('Tidak ada data opname untuk disimpan!', 'error');
                return;
            }

            // Create adjustment transactions for differences
            const adjustments = [];
            existingOpname.data.forEach(item => {
                if (item.selisih !== 0) {
                    const adjustmentTransaction = {
                        id: Date.now() + Math.random(),
                        tanggal: new Date().toISOString().split('T')[0],
                        sku: item.sku,
                        sparepart: item.sparepart,
                        jenis: item.jenis,
                        merk: item.merk,
                        tipe_transaksi: item.selisih > 0 ? 'masuk' : 'keluar',
                        jumlah: Math.abs(item.selisih),
                        harga: item.harga,
                        keterangan: `Adjustment Stock Opname ${opnameMonth} - ${item.keterangan}`,
                        total: Math.abs(item.selisih) * item.harga
                    };
                    adjustments.push(adjustmentTransaction);
                }
            });

            if (adjustments.length > 0) {
                dailyTransactions.push(...adjustments);
                saveAllData(); // Auto-save dengan backup
                showAlert(`Hasil opname disimpan! ${adjustments.length} adjustment dibuat.`, 'success');
            } else {
                showAlert('Tidak ada perbedaan stock untuk disesuaikan.', 'success');
            }
        }

        // Export functions
        function exportDailyTransactions() {
            const data = dailyTransactions;
            const csv = convertToCSV(data, [
                'tanggal', 'sku', 'sparepart', 'jenis', 'merk', 'tipe_transaksi', 
                'jumlah', 'harga', 'total', 'keterangan'
            ]);
            downloadCSV(csv, 'transaksi_harian.csv');
        }

        function exportMonthlyReport() {
            const reportMonth = document.getElementById('reportMonth').value;
            const existingReport = monthlyReports.find(r => r.month === reportMonth);
            
            if (!existingReport) {
                showAlert('Generate laporan bulanan terlebih dahulu!', 'error');
                return;
            }

            const csv = convertToCSV(existingReport.data, [
                'sku', 'sparepart', 'jenis', 'merk', 'stockAwal', 'hargaAwal', 'masuk',
                'keluar', 'stockAkhir', 'hargaRataRataWeighted', 'totalValue'
            ]);
            downloadCSV(csv, `laporan_bulanan_${reportMonth}.csv`);
        }

        function exportOpnameReport() {
            const opnameMonth = document.getElementById('opnameMonth').value;
            const existingOpname = opnameData.find(o => o.month === opnameMonth);
            
            if (!existingOpname) {
                showAlert('Tidak ada data opname untuk di-export!', 'error');
                return;
            }

            const csv = convertToCSV(existingOpname.data, [
                'sku', 'sparepart', 'jenis', 'merk', 'stockSistem', 'stockFisik', 'selisih',
                'harga', 'valueSistem', 'valueFisik', 'keterangan'
            ]);
            downloadCSV(csv, `stock_opname_${opnameMonth}.csv`);
        }

        function convertToCSV(data, headers) {
            const csvHeaders = headers.join(',');
            const csvData = data.map(row => 
                headers.map(header => `"${row[header] || ''}"`).join(',')
            ).join('\n');
            
            return csvHeaders + '\n' + csvData;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Data backup and restore functions
        function exportAllData() {
            const backupData = {
                dailyTransactions,
                monthlyReports,
                opnameData,
                exportedAt: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `stock-opname-backup-${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showAlert('Data backup berhasil di-export!', 'success');
        }

        function importData() {
            if (!hasPermission('importData')) {
                showAlert('Anda tidak memiliki izin untuk import data!', 'error');
                return;
            }
            document.getElementById('importFile').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm('Import data akan mengganti data yang ada. Lanjutkan?')) {
                        if (importedData.dailyTransactions) {
                            dailyTransactions = importedData.dailyTransactions;
                        }
                        if (importedData.monthlyReports) {
                            monthlyReports = importedData.monthlyReports;
                        }
                        if (importedData.opnameData) {
                            opnameData = importedData.opnameData;
                        }
                        
                        saveAllData();
                        
                        // Refresh displays
                        updateDailyStatistics();
                        displayDailyTransactions();
                        displayMonthlyReport();
                        displayOpnameData();
                        updateSparepartsList();
                        
                        showAlert(`Data berhasil di-import! Imported: ${importedData.exportedAt || 'Unknown date'}`, 'success');
                    }
                } catch (error) {
                    showAlert('Error import data: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // CSV Import functions
        function importCSV() {
            if (!hasPermission('importCSV')) {
                showAlert('Anda tidak memiliki izin untuk import CSV!', 'error');
                return;
            }
            document.getElementById('importCSVFile').click();
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const result = [];
            
            if (lines.length < 2) {
                throw new Error('File CSV harus memiliki minimal header dan 1 baris data');
            }

            // Parse header
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            // Expected headers (SKU is optional for backward compatibility)
            const requiredHeaders = ['tanggal', 'sparepart', 'jenis', 'merk', 'tipe_transaksi', 'jumlah', 'harga', 'keterangan'];
            const missingHeaders = requiredHeaders.filter(h => !headers.some(header => header.toLowerCase() === h));
            
            if (missingHeaders.length > 0) {
                throw new Error(`Header yang hilang: ${missingHeaders.join(', ')}`);
            }

            // Parse data rows
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // Skip empty lines
                
                const values = parseCSVLine(line);
                
                if (values.length !== headers.length) {
                    throw new Error(`Baris ${i + 1}: Jumlah kolom tidak sesuai dengan header`);
                }

                const row = {};
                headers.forEach((header, index) => {
                    row[header.toLowerCase()] = values[index];
                });

                result.push(row);
            }

            return result;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        }

        function validateCSVData(csvData) {
            const errors = [];
            const warnings = [];
            
            csvData.forEach((row, index) => {
                const lineNumber = index + 2; // +2 because index starts at 0 and we skip header
                
                // Validate required fields
                if (!row.tanggal) {
                    errors.push(`Baris ${lineNumber}: Tanggal harus diisi`);
                } else {
                    // Validate date format
                    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                    if (!dateRegex.test(row.tanggal)) {
                        errors.push(`Baris ${lineNumber}: Format tanggal harus YYYY-MM-DD (${row.tanggal})`);
                    }
                }
                
                if (!row.sparepart || row.sparepart.trim().length < 2) {
                    errors.push(`Baris ${lineNumber}: Nama barang harus minimal 2 karakter`);
                }
                
                if (!row.jenis) {
                    errors.push(`Baris ${lineNumber}: Jenis harus diisi`);
                }
                
                if (!row.merk || row.merk.trim().length < 1) {
                    errors.push(`Baris ${lineNumber}: Merk harus diisi`);
                }
                
                if (!row.tipe_transaksi || !['stock_awal', 'masuk', 'keluar'].includes(row.tipe_transaksi)) {
                    errors.push(`Baris ${lineNumber}: Tipe transaksi harus salah satu dari: stock_awal, masuk, keluar`);
                }
                
                const jumlah = parseInt(row.jumlah);
                if (isNaN(jumlah) || jumlah <= 0) {
                    errors.push(`Baris ${lineNumber}: Jumlah harus berupa angka positif`);
                }
                
                const harga = parseFloat(row.harga);
                if (row.tipe_transaksi !== 'keluar' && (isNaN(harga) || harga <= 0)) {
                    errors.push(`Baris ${lineNumber}: Harga harus berupa angka positif untuk transaksi ${row.tipe_transaksi}`);
                }
            });
            
            return { errors, warnings };
        }

        function handleImportCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showAlert('File harus berformat CSV!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const csvData = parseCSV(csvText);
                    
                    // Validate data
                    const validation = validateCSVData(csvData);
                    
                    if (validation.errors.length > 0) {
                        showAlert('Error validasi CSV:\n\n' + validation.errors.join('\n'), 'error');
                        return;
                    }
                    
                    // Convert CSV data to transaction format
                    const transactions = csvData.map(row => ({
                        id: Date.now() + Math.random(),
                        tanggal: row.tanggal,
                        sku: row.sku ? row.sku.trim().toUpperCase() : '', // Normalize SKU to uppercase
                        sparepart: row.sparepart.trim(),
                        jenis: row.jenis,
                        merk: row.merk.trim(),
                        tipe_transaksi: row.tipe_transaksi,
                        jumlah: parseInt(row.jumlah),
                        harga: parseFloat(row.harga) || 0,
                        keterangan: row.keterangan || 'Import CSV',
                        total: parseInt(row.jumlah) * (parseFloat(row.harga) || 0)
                    }));
                    
                    // Show confirmation
                    const confirmMessage = `Akan mengimport ${transactions.length} transaksi dari CSV.\n\nLanjutkan?`;
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    // Add to daily transactions
                    dailyTransactions.push(...transactions);
                    saveAllData();
                    
                    // Refresh all displays and statistics
                    updateDailyStatistics();
                    displayDailyTransactions();
                    updateSparepartsList();
                    
                    showAlert(`Berhasil import ${transactions.length} transaksi dari CSV!`, 'success');
                    
                } catch (error) {
                    showAlert('Error parsing CSV: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // Delete all data function with multi-step validation
        function deleteAllData() {
            if (!hasPermission('deleteAllData')) {
                showAlert('Anda tidak memiliki izin untuk menghapus semua data!', 'error');
                return;
            }
            // Step 1: Initial warning
            const step1 = confirm(
                '‚ö†Ô∏è PERINGATAN KERAS ‚ö†Ô∏è\n\n' +
                'Anda akan MENGHAPUS SEMUA DATA termasuk:\n' +
                '‚Ä¢ Semua transaksi harian\n' +
                '‚Ä¢ Semua laporan bulanan\n' +
                '‚Ä¢ Semua data stock opname\n\n' +
                'Data yang dihapus TIDAK DAPAT DIKEMBALIKAN!\n\n' +
                'Pastikan Anda sudah melakukan BACKUP terlebih dahulu.\n\n' +
                'Lanjutkan ke tahap konfirmasi?'
            );
            
            if (!step1) {
                showAlert('Penghapusan data dibatalkan.', 'info');
                return;
            }
            
            // Step 2: Check if user has backup
            const step2 = confirm(
                'üîÑ KONFIRMASI BACKUP\n\n' +
                'Apakah Anda sudah melakukan backup data?\n\n' +
                'Jika belum, silakan klik "Cancel" dan lakukan backup terlebih dahulu dengan tombol "Backup Data".\n\n' +
                'Jika sudah backup, klik "OK" untuk lanjut.'
            );
            
            if (!step2) {
                showAlert('Silakan lakukan backup terlebih dahulu sebelum menghapus data.', 'warning');
                return;
            }
            
            // Step 3: Show current data stats
            const totalTransactions = dailyTransactions.length;
            const totalReports = monthlyReports.length;
            const totalOpname = opnameData.length;
            
            const step3 = confirm(
                'üìä DATA YANG AKAN DIHAPUS:\n\n' +
                `‚Ä¢ Transaksi Harian: ${totalTransactions} record\n` +
                `‚Ä¢ Laporan Bulanan: ${totalReports} laporan\n` +
                `‚Ä¢ Data Stock Opname: ${totalOpname} opname\n\n` +
                'Apakah Anda yakin ingin menghapus SEMUA data ini?\n\n' +
                'Sekali lagi, data yang dihapus TIDAK DAPAT DIKEMBALIKAN!'
            );
            
            if (!step3) {
                showAlert('Penghapusan data dibatalkan.', 'info');
                return;
            }
            
            // Step 4: Final confirmation with typing
            const confirmText = prompt(
                'üö® KONFIRMASI TERAKHIR üö®\n\n' +
                'Untuk melanjutkan penghapusan, ketik kata berikut:\n\n' +
                'HAPUS SEMUA DATA\n\n' +
                '(Ketik persis seperti di atas, huruf besar semua)'
            );
            
            if (confirmText !== 'HAPUS SEMUA DATA') {
                showAlert('Konfirmasi tidak sesuai. Penghapusan data dibatalkan.', 'error');
                return;
            }
            
            // Step 5: Execute deletion
            try {
                // Clear all data arrays
                dailyTransactions.length = 0;
                monthlyReports.length = 0;
                opnameData.length = 0;
                
                // Save empty data to localStorage
                saveAllData();
                
                // Refresh all displays
                updateDailyStatistics();
                displayDailyTransactions();
                displayMonthlyReport();
                displayOpnameData();
                updateSparepartsList();
                
                // Clear all form fields
                document.getElementById('dailyTransactionForm').reset();
                document.getElementById('reportMonth').value = '';
                document.getElementById('opnameMonth').value = '';
                
                showAlert(
                    '‚úÖ SEMUA DATA BERHASIL DIHAPUS!\n\n' +
                    `Dihapus:\n` +
                    `‚Ä¢ ${totalTransactions} transaksi harian\n` +
                    `‚Ä¢ ${totalReports} laporan bulanan\n` +
                    `‚Ä¢ ${totalOpname} data stock opname\n\n` +
                    'Sistem sudah bersih dan siap untuk data baru.',
                    'success'
                );
                
            } catch (error) {
                showAlert('Error saat menghapus data: ' + error.message, 'error');
            }
        }

        // Data integrity check
        function checkDataIntegrity() {
            const issues = [];
            const duplicates = [];
            const stockIssues = [];
            const priceIssues = [];

            // Group transactions by item (use SKU if available, fallback to name+jenis+merk)
            const itemGroups = {};
            dailyTransactions.forEach(t => {
                const key = t.sku || `${t.sparepart.toLowerCase().trim()}_${t.jenis}_${t.merk.toLowerCase().trim()}`;
                if (!itemGroups[key]) {
                    itemGroups[key] = [];
                }
                itemGroups[key].push(t);
            });

            // Check each item group
            Object.keys(itemGroups).forEach(itemKey => {
                const transactions = itemGroups[itemKey];
                const itemName = transactions[0].sparepart;

                // Check for multiple stock_awal
                const stockAwalCount = transactions.filter(t => t.tipe_transaksi === 'stock_awal').length;
                if (stockAwalCount > 1) {
                    issues.push(`${itemName}: Memiliki ${stockAwalCount} stock awal`);
                }

                // Check stock calculation
                let currentStock = 0;
                let hasNegativeStock = false;
                transactions.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal)).forEach(t => {
                    if (t.tipe_transaksi === 'stock_awal' || t.tipe_transaksi === 'masuk') {
                        currentStock += t.jumlah;
                    } else if (t.tipe_transaksi === 'keluar') {
                        currentStock -= t.jumlah;
                        if (currentStock < 0 && !hasNegativeStock) {
                            stockIssues.push(`${itemName}: Stock negatif pada ${t.tanggal} (${currentStock})`);
                            hasNegativeStock = true;
                        }
                    }
                });

                // Check price consistency
                const pricesWithDates = transactions.filter(t => t.harga > 0)
                    .map(t => ({ harga: t.harga, tanggal: t.tanggal }))
                    .sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

                if (pricesWithDates.length > 1) {
                    const prices = pricesWithDates.map(p => p.harga);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const priceVariation = (maxPrice - minPrice) / minPrice;

                    if (priceVariation > 0.5) { // More than 50% variation
                        priceIssues.push(`${itemName}: Variasi harga tinggi - Min: Rp ${minPrice.toLocaleString('id-ID')}, Max: Rp ${maxPrice.toLocaleString('id-ID')}`);
                    }
                }

                // Check for exact duplicates (same date, same type, same amount)
                const duplicateCheck = {};
                transactions.forEach(t => {
                    const dupKey = `${t.tanggal}_${t.tipe_transaksi}_${t.jumlah}_${t.harga}`;
                    if (duplicateCheck[dupKey]) {
                        duplicates.push(`${itemName}: Kemungkinan duplikat pada ${t.tanggal} (${t.tipe_transaksi}, ${t.jumlah} unit)`);
                    } else {
                        duplicateCheck[dupKey] = true;
                    }
                });
            });

            // Display results
            let message = 'HASIL CEK KONSISTENSI DATA:\n\n';
            
            if (issues.length === 0 && stockIssues.length === 0 && priceIssues.length === 0 && duplicates.length === 0) {
                message += '‚úÖ Tidak ditemukan masalah dalam data!\n\n';
            } else {
                if (issues.length > 0) {
                    message += 'üö® MASALAH UTAMA:\n' + issues.join('\n') + '\n\n';
                }
                
                if (stockIssues.length > 0) {
                    message += '‚ö†Ô∏è MASALAH STOCK:\n' + stockIssues.join('\n') + '\n\n';
                }
                
                if (duplicates.length > 0) {
                    message += 'üîÑ KEMUNGKINAN DUPLIKAT:\n' + duplicates.join('\n') + '\n\n';
                }
                
                if (priceIssues.length > 0) {
                    message += 'üí∞ VARIASI HARGA:\n' + priceIssues.join('\n') + '\n\n';
                }
            }
            
            message += `Total Transaksi: ${dailyTransactions.length}\n`;
            message += `Total Item Unik: ${Object.keys(itemGroups).length}`;

            alert(message);
        }
    </script>

    <!-- Footer -->
    <footer style="
        text-align: center; 
        padding: 15px 20px; 
        margin-top: 30px; 
        color: white; 
        font-size: 14px; 
        font-weight: 500;
    ">
        Powered By <span style="color: #ffffff; font-weight: 600;">SigmaTech</span>
    </footer>
</body>
</html>